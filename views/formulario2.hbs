<form action="/formulario/inserir" method="POST" id="formParte2">
    <input type="hidden" name="parte" value="2">
    <input type="hidden" name="idFormulario" value="{{idFormulario}}">

    <div class="card">
        <div class="card-body">
            <h5 class="section-title">2. Sobre o PSF</h5>

            <div class="mb-3">
                <label class="form-label fw-bold">Antes de vir ao PAM, você procurou seu PSF?</label>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="procurou_psf" id="psf_sim" value="Sim"
                            required>
                        <label class="form-check-label" for="psf_sim">Sim</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="procurou_psf" id="psf_nao" value="Nao"
                            required>
                        <label class="form-check-label" for="psf_nao">Não</label>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Qual é o seu PSF de referência?</label>
                <select class="form-control" name="nome_psf" id="nome_psf" required>
                    <option value="">Selecione...</option>
                    <option value="Rosa Mística">Rosa Mística</option>
                    <option value="Divino">Divino</option>
                    <option value="Não Sei">Não Sei</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Se não foi ao PSF, qual o principal motivo?</label>

                <div id="motivo_nao_psf_container">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="motivo_nao_psf[]"
                            value="Não sabia qual era meu PSF" id="motivo_1">
                        <label class="form-check-label" for="motivo_1">Não sabia qual era meu PSF</label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="motivo_nao_psf[]"
                            value="O PSF estava fechado" id="motivo_2">
                        <label class="form-check-label" for="motivo_2">O PSF estava fechado</label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="motivo_nao_psf[]"
                            value="Preferi vir direto ao PAM" id="motivo_3">
                        <label class="form-check-label" for="motivo_3">Preferi vir direto ao PAM</label>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="motivo_nao_psf[]"
                            value="Não consegui atendimento no PSF" id="motivo_4">
                        <label class="form-check-label" for="motivo_4">Não consegui atendimento no PSF</label>
                    </div>

                    <div class="outro-motivo">
                        <input class="form-check-input" type="checkbox" name="motivo_nao_psf[]" value="Outro"
                            id="motivo_outro">
                        <label class="form-check-label" for="motivo_outro">Outro motivo:</label>

                        <input type="text" class="form-control" name="motivo_nao_psf_outro" placeholder="Especifique"
                            id="motivo_outro_input">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 mb-5 mt-3" style="grid-template-columns: 1fr 2fr;">
        <button type="button" class="btn btn-primary btn-lg" onclick="history.back()">
            Voltar
        </button>
        <button type="submit" class="btn btn-success btn-lg" id="btn-proxima" disabled>
            Próxima
        </button>
    </div>
</form>

<script>
    const form = document.getElementById('formParte2');
    const btnProxima = document.getElementById('btn-proxima');
    const psfSim = document.getElementById('psf_sim');
    const psfNao = document.getElementById('psf_nao');
    const motivoSection = document.querySelector('#motivo_nao_psf_container').parentElement;
    const motivoContainer = document.getElementById('motivo_nao_psf_container');
    const checkboxes = motivoContainer.querySelectorAll('input[type="checkbox"]');
    const outroCheckbox = document.getElementById('motivo_outro');
    const outroInput = document.getElementById('motivo_outro_input');

    function validarFormulario() {
        let valido = true;

        const radioProcurou = form.querySelectorAll('input[name="procurou_psf"]');
        const procurouSelecionado = Array.from(radioProcurou).some(r => r.checked);
        if (!procurouSelecionado) valido = false;

        const nomePsf = document.getElementById('nome_psf');
        if (!nomePsf.value) valido = false;

        if (psfNao.checked) {
            const algumCheckbox = Array.from(checkboxes).some(c => c.checked);
            if (!algumCheckbox) {
                valido = false;
            } else if (outroCheckbox.checked && !outroInput.value.trim()) {
                valido = false;
            }
        }

        btnProxima.disabled = !valido;
    }

    function atualizarVisibilidadeMotivos() {
        if (psfNao.checked) {
            motivoSection.style.display = 'block';
        } else {
            motivoSection.style.display = 'none';
            checkboxes.forEach(c => c.checked = false);
            outroInput.value = '';
            outroInput.disabled = true;
            outroInput.removeAttribute('required');
        }
        validarFormulario();
    }

    function atualizarOutroMotivo() {
        if (outroCheckbox.checked) {
            outroInput.disabled = false;
            outroInput.setAttribute('required', 'required');
        } else {
            outroInput.value = '';
            outroInput.disabled = true;
            outroInput.removeAttribute('required');
        }
        validarFormulario();
    }

    form.addEventListener('input', validarFormulario);
    form.addEventListener('change', validarFormulario);

    form.addEventListener('submit', function (e) {
        if (outroCheckbox.checked) {
            outroCheckbox.checked = false;
            const textoOutro = outroInput.value.trim();
            if (textoOutro !== '') {
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'motivo_nao_psf[]';
                hidden.value = textoOutro;
                form.appendChild(hidden);
            }
        }
        outroInput.disabled = true;
    });

    psfSim.addEventListener('change', atualizarVisibilidadeMotivos);
    psfNao.addEventListener('change', atualizarVisibilidadeMotivos);
    outroCheckbox.addEventListener('change', atualizarOutroMotivo);

    atualizarVisibilidadeMotivos();
    atualizarOutroMotivo();
    validarFormulario();
</script>